generator client {
  provider = "prisma-client-js"
  // Output to the hidden .prisma folder under node_modules so imports from
  // `@prisma/client` continue to work and generated files are isolated.
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// -----------------------------------------------------------------------------
// ENUMS
// -----------------------------------------------------------------------------

/// Alert types
enum AlertType {
  GEOFENCE_ENTER
  GEOFENCE_EXIT
  BATTERY_LOW
  OFFLINE
  SOS
  OVERSPEED
  VIBRATION
  CUSTOM
}

/// Alert severity levels
enum AlertSeverity {
  INFO
  WARNING
  CRITICAL
}

/// Notification channels
enum NotificationChannel {
  CONSOLE
  EMAIL
  SMS
  PUSH
  WEBHOOK
}

// -----------------------------------------------------------------------------
// USER / AUTH / ENTITIES
// -----------------------------------------------------------------------------

model User {
  id           String   @id @default(uuid())
  fullName     String
  email        String   @unique
  phone        String?
  role         String
  passwordHash String
  createdAt    DateTime @default(now())

  // relations
  trackers      Tracker[]
  subscriptions Subscription[]
  wallet        Wallet?
  payments      PaymentRecord[]
  geofences     Geofence[]
  alerts        Alert[]
  vehicles      Vehicle[]
  alertSettings AlertSetting[]
}

// -----------------------------------------------------------------------------
// VEHICLE / TRACKER / ASSIGNMENTS
// -----------------------------------------------------------------------------

model Vehicle {
  id        String   @id @default(uuid())
  userId    String
  name      String
  type      String // car, moto, truck, asset, etc.
  brand     String?
  model     String?
  plate     String?  @unique
  createdAt DateTime @default(now())

  user        User                @relation(fields: [userId], references: [id])
  assignments TrackerAssignment[]
}

model Tracker {
  id                String    @id @default(uuid())
  imei              String    @unique
  label             String?
  model             String
  protocol          String // gt06, osmand, traccar, custom
  simNumber         String?
  iccid             String? // SIM ID
  apn               String?
  ipServer          String?
  port              Int?
  status            String // active, inactive, installed, lost
  batteryLevel      Float?
  lastCommunication DateTime?
  isDeleted         Boolean   @default(false)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  // relations
  positions      Position[]
  alerts         Alert[]
  assignments    TrackerAssignment[]
  configLogs     TrackerConfigLog[]
  geofences      Geofence[]          @relation("TrackerGeofences")
  geofenceEvents GeofenceEvent[]
}

model TrackerAssignment {
  id         String    @id @default(uuid())
  trackerId  String
  vehicleId  String
  assignedAt DateTime  @default(now())
  removedAt  DateTime?

  tracker Tracker @relation(fields: [trackerId], references: [id])
  vehicle Vehicle @relation(fields: [vehicleId], references: [id])
}

// -----------------------------------------------------------------------------
// POSITIONS
// -----------------------------------------------------------------------------

model Position {
  id           String                               @id @default(uuid())
  trackerId    String
  latitude     Float
  longitude    Float
  speed        Float?
  direction    Float?
  altitude     Float?
  eventType    String?
  batteryLevel Float?
  externalId   String?                              @unique
  odometer     Float?
  accuracy     Float?
  source       String?
  createdAt    DateTime                             @default(now())
  timestamp    DateTime
  // PostGIS geometry column for spatial queries. Exposed as Unsupported so Prisma client can still be generated.
  location     Unsupported("geometry(Point,4326)")?

  tracker        Tracker         @relation(fields: [trackerId], references: [id])
  geofenceEvents GeofenceEvent[]

  @@index([trackerId, timestamp])
}

// -----------------------------------------------------------------------------
// ALERTS & NOTIFICATIONS
// -----------------------------------------------------------------------------

model Alert {
  id          String        @id @default(uuid())
  trackerId   String?
  userId      String? // l'alerte peut être globale (userId null) ou ciblée
  type        AlertType // event type (enum)
  title       String? // court résumé/label
  message     String // message complet (texte)
  severity    AlertSeverity // importance
  metadata    Json? // JSON libre (ex: speed, distance, geofenceId)
  status      String        @default("new") // new, sent, acknowledged, dismissed
  createdAt   DateTime      @default(now())
  deliveredAt DateTime?

  // relations
  tracker      Tracker?           @relation(fields: [trackerId], references: [id])
  user         User?              @relation(fields: [userId], references: [id])
  deliveryLogs AlertDeliveryLog[]

  // indexes pour recherches rapides
  @@index([userId, createdAt])
  @@index([trackerId, createdAt])
  @@index([type, createdAt])
}

model AlertSetting {
  id         String   @id @default(uuid())
  userId     String
  enabled    Boolean  @default(true)
  channels   Json // ex: { "email": true, "sms": false, "push": true }
  thresholds Json? // ex: { "overspeed": 100, "battery_low": 15 }
  timezone   String? // préférence timezone pour timestamps
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@unique([userId]) // 1 param set par user
}

model AlertDeliveryLog {
  id          String              @id @default(uuid())
  alertId     String
  channel     NotificationChannel
  status      String // pending, success, failure
  providerRef String? // id renvoyé par le provider (ex: twilio id)
  error       String? // message d'erreur si échec
  attemptedAt DateTime            @default(now())
  processedAt DateTime?

  alert Alert @relation(fields: [alertId], references: [id])

  @@index([alertId])
  @@index([channel, status])
}

// -----------------------------------------------------------------------------
// TRACKER COMMAND LOGS
// -----------------------------------------------------------------------------

model TrackerConfigLog {
  id        String   @id @default(uuid())
  trackerId String
  command   String // ex: "SET_IP 102.12.12.14 5010"
  status    String // success, pending, failed
  response  String?
  createdAt DateTime @default(now())

  tracker Tracker @relation(fields: [trackerId], references: [id])
}

// -----------------------------------------------------------------------------
// FINTECH / BILLING Subscription / Wallet / Payment models
// -----------------------------------------------------------------------------

model Plan {
  id          String   @id @default(uuid())
  key         String   @unique                 // "starter", "pro", "premium"
  name        String
  description String?
  pricePerDay Float    // en FCFA (ou unité choisie)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  subscriptions Subscription[]
}

model Wallet {
  id        String   @id @default(uuid())
  userId    String   @unique
  balance   Float    @default(0)
  frozen    Boolean  @default(false) // freeze for anti-fraud
  loyaltyPoints Int @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User               @relation(fields: [userId], references: [id])
  transactions WalletTransaction[]
}

model WalletTransaction {
  id          String   @id @default(uuid())
  walletId    String
  type        String   // TOPUP | DEBIT | TRANSFER_IN | TRANSFER_OUT | REFUND
  amount      Float
  currency    String   @default("XAF")
  metadata    Json?    // free data (reason, externalRef, paymentId)
  createdAt   DateTime @default(now())

  wallet Wallet @relation(fields: [walletId], references: [id])
  @@index([walletId, createdAt])
}

model PaymentRecord {
  id          String   @id @default(uuid())
  userId      String
  amount      Float
  currency    String   @default("XAF")
  method      String   // "simulated_mobile_money", "simulated_card", "real_provider"
  status      String   // pending, success, failure
  providerRef String?  // external provider id if any
  metadata    Json?
  idempotencyKey String? @unique
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
  @@index([userId, createdAt])
}

model Subscription {
  id         String   @id @default(uuid())
  userId     String
  planId     String
  active     Boolean  @default(true)
  startDate  DateTime @default(now())
  endDate    DateTime? // optional expiry
  lastChargedAt DateTime? // last successful daily charge
  suspendedAt DateTime?
  suspensionReason String?
  retryCount Int @default(0)
  lastRetryAt DateTime?
  prepaidUntil DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
  plan Plan @relation(fields: [planId], references: [id])
  @@index([userId])
  @@index([planId])
}

model AuditTrail {
  id         String   @id @default(uuid())
  userId     String?
  action     String
  targetModel String?
  targetId   String?
  beforeData Json?
  afterData  Json?
  ip         String?
  createdAt  DateTime @default(now())
}

// -----------------------------------------------------------------------------
// GEOFENCES & EVENTS
// -----------------------------------------------------------------------------

model Geofence {
  id          String   @id @default(uuid())
  name        String
  description String?
  type        String // "circle" ou "polygon"
  radius      Float?
  center      Json?
  coordinates Json? // for polygon
  color       String?
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  trackers       Tracker[]       @relation("TrackerGeofences")
  geofenceEvents GeofenceEvent[]
  user           User            @relation(fields: [userId], references: [id])
  userId         String
}

model GeofenceEvent {
  id         String   @id @default(uuid())
  trackerId  String
  geofenceId String
  type       String // "enter" | "exit"
  timestamp  DateTime @default(now())
  positionId String // OBLIGATOIRE : FK vers Position
  meta       Json? // optionnel : distance, speed, etc.
  createdAt  DateTime @default(now())

  tracker  Tracker  @relation(fields: [trackerId], references: [id])
  geofence Geofence @relation(fields: [geofenceId], references: [id])
  position Position @relation(fields: [positionId], references: [id])

  @@index([trackerId, timestamp])
  @@index([geofenceId, timestamp])
}
